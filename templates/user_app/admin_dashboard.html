{% extends 'admin_base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Total Users</h6>
                        <h3 class="mb-0">{{ total_users }}</h3>
                    </div>
                    <i class="fas fa-users fa-lg text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Total Orders</h6>
                        <h3 class="mb-0">{{ total_orders }}</h3>
                    </div>
                    <i class="fas fa-cart-shopping fa-lg text-primary"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Total Revenue</h6>
                        <h3 class="mb-0">₹{{ total_revenue|floatformat:2 }}</h3>
                    </div>
                    <i class="fas fa-dollar-sign fa-lg text-primary"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Chart -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Sales Overview</h5>
                <select id="timeFilter" class="form-select w-auto">
                    <option value="daily" {% if time_filter == 'daily' %}selected{% endif %}>Daily</option>
                    <option value="weekly" {% if time_filter == 'weekly' %}selected{% endif %}>Weekly</option>
                    <option value="monthly" {% if time_filter == 'monthly' %}selected{% endif %}>Monthly</option>
                    <option value="yearly" {% if time_filter == 'yearly' %}selected{% endif %}>Yearly</option>
                </select>
            </div>
            <div style="position: relative; height: 350px;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Top Selling Sections -->
    <div class="row g-3">
        <!-- Top Products -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Top 10 Products</h5>
                    <ul class="list-group list-group-flush">
                        {% for product in top_products %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ product.variant__product__product_name }}</span>
                            <span class="badge bg-primary">{{ product.total_sold }} sold</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No data available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Top Categories -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Top 10 Categories</h5>
                    <ul class="list-group list-group-flush">
                        {% for category in top_categories %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ category.variant__product__category__name }}</span>
                            <span class="badge bg-primary">{{ category.total_sold }} sold</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No data available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- Top Brands -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Top 10 Brands</h5>
                    <ul class="list-group list-group-flush">
                        {% for brand in top_brands %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ brand.variant__product__brand__name|default:"No Brand" }}</span>
                            <span class="badge bg-primary">{{ brand.total_sold }} sold</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No data available</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Sales Chart
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        const salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: {{ sales_labels|safe }},
                datasets: [{
                    label: 'Sales (₹)',
                    data: {{ sales_data|safe }},
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Revenue (₹)' }
                    },
                    x: {
                        title: { display: true, text: 'Time' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Time Filter Handler
        document.getElementById('timeFilter').addEventListener('change', function () {
            const filter = this.value;
            window.location.href = `?time_filter=${filter}`;
        });
    });
</script>
{% endblock %}