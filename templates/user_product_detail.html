{% extends 'base.html' %}
{% load static cart_filters %}

{% block title %}{{ product.product_name }} - Core Fitness{% endblock %}

{% block content %}
<style>
    /* Existing zoom styles remain unchanged */
    .zoom-container {
        position: relative;
        overflow: hidden;
        cursor: crosshair;
    }

    .zoom-lens {
        position: absolute;
        border: 1px solid #d4d4d4;
        width: 80px;
        height: 80px;
        background-color: rgba(255, 255, 255, 0.4);
        cursor: crosshair;
        display: none;
        z-index: 1001;
    }

    .zoom-result {
        position: fixed;
        right: 20px;
        border: 1px solid #d4d4d4;
        width: 300px;
        height: 300px;
        background-repeat: no-repeat;
        background-color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        border-radius: 5px;
        pointer-events: none;
    }

    .carousel-item.active .zoom-result {
        left: 100%;
        top: 0;
        margin-left: 10px;
    }

    .zoom-lens.active, .zoom-result.active {
        display: block !important;
    }

</style>

<div class="container mt-4">
    <!-- Existing breadcrumb, product images, and details remain unchanged -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'user_app:user_home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product_app:user_product_list' %}">Products</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.product_name }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Product Images (unchanged) -->
        <div class="col-md-6 mb-4">
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    {% for image in images %}
                    <button type="button" data-bs-target="#productCarousel" data-bs-slide-to="{{ forloop.counter0 }}" 
                        {% if forloop.first %}class="active" aria-current="true"{% endif %} 
                        aria-label="Slide {{ forloop.counter }}"></button>
                    {% endfor %}
                </div>
                <div class="carousel-inner rounded shadow">
                    {% for image in images %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <div class="zoom-container">
                            <img src="{{ image.image.url }}" class="d-block w-100 zoom-image" alt="{{ product.product_name }}">
                            <div class="zoom-lens"></div>
                            <div class="zoom-result"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- Thumbnail Navigation (unchanged) -->
            <div class="row mt-3 g-2 d-none d-md-flex">
                {% for image in images %}
                <div class="col-3">
                    <img src="{{ image.image.url }}" class="img-thumbnail thumbnail-nav" 
                        alt="Thumbnail {{ forloop.counter }}" 
                        data-bs-target="#productCarousel" 
                        data-bs-slide-to="{{ forloop.counter0 }}">
                </div>
                {% endfor %}
            </div>
            
            <!-- Zoom Instructions (unchanged) -->
            <div class="text-center mt-2">
                <small class="text-muted"><i class="bi bi-zoom-in"></i> Hover to zoom, click to enlarge</small>
            </div>
        </div>

        <!-- Product Details (unchanged) -->
        <div class="col-md-6">
            <div class="card border-0 h-100">
                <div class="card-body d-flex flex-column">
                    <h1 class="card-title h2">{{ product.product_name }}</h1>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-primary me-2">{{ product.category.name }}</span>
                        <p class="text-muted mb-0">Brand: <strong>{{ product.brand }}</strong></p>
                    </div>

                    <!-- Average Rating Display (unchanged) -->
                    
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            {% if review_count > 0 %}
                                <div class="rating-stars me-2">
                                    {% for i in "12345" %}
                                        {% with star_num=forloop.counter rating_float=average_rating|floatformat:"1" %}
                                            {% with floored=rating_float|floatformat:'0' %}
                                                {% with decimal=average_rating|subtract:floored|floatformat:"1"|add:"0" %}
                                                    <i class="bi bi-star{% if star_num <= 3 and star_num <= floored|add:'0' %}-fill{% elif star_num == 4 and decimal|add:'0' >= 0.3 %}-half{% endif %} text-warning"></i>
                                                {% endwith %}
                                            {% endwith %}
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                                <span>{{ average_rating|floatformat:1 }} / 5</span>
                                <a href="#reviews" class="ms-2 text-decoration-none">({{ review_count }} reviews)</a>
                            {% else %}
                                <span class="text-muted">No reviews yet.</span>
                                <a href="#reviews" class="ms-2 text-decoration-none">Be the first to review!</a>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-4">
                        <p class="card-text">{{ product.description }}</p>
                    </div>

                    <!-- Variant Selection (unchanged) -->
                    <form id="addToCartForm" method="POST" action="" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="variantSelect" class="form-label fw-bold">Select Variant:</label>
                            <select class="form-select" id="variantSelect" name="variant_id" required>
                                {% for variant in variants %}
                                <option value="{{ variant.id }}" 
                                        data-price="{{ variant.price }}" 
                                        data-stock="{{ variant.stock }}"
                                        data-flavor="{{ variant.flavor|default:'Standard' }}"
                                        data-size="{{ variant.size_weight|default:'N/A' }}"
                                        {% if forloop.first %}selected{% endif %}>
                                    {{ variant.flavor|default:'Standard' }} - {{ variant.size_weight|default:'N/A' }} - ${{ variant.price }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    
                        <div class="variant-details mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h3 class="h5 mb-0">Price: <span id="selectedPrice" class="text-primary fw-bold">$0.00</span></h3>
                                <span id="stockStatus" class="badge bg-success">In Stock</span>
                            </div>
                            
                            <div class="d-flex align-items-center mb-3">
                                <label for="quantity" class="form-label me-3 mb-0 fw-bold">Quantity:</label>
                                <div class="input-group quantity-selector" style="width: 130px;">
                                    <button type="button" class="btn btn-outline-secondary quantity-btn" id="decreaseQuantity">-</button>
                                    <input type="number" class="form-control text-center" id="quantity" name="quantity" value="1" min="1" max="10">
                                    <button type="button" class="btn btn-outline-secondary quantity-btn" id="increaseQuantity">+</button>
                                </div>
                            </div>
                        </div>
                    
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" id="addToCartBtn">
                                <i class="bi bi-cart-plus me-2"></i>Add to Cart
                            </button>
                            <button type="button" class="btn btn-success btn-lg" id="buyNowBtn">
                                <i class="bi bi-lightning-fill me-2"></i>Buy Now
                            </button>
                            <button type="button" class="btn btn-danger btn-lg" id="addToWishlistBtn">
                                <i class="bi bi-heart me-2"></i>Add to Wishlist
                            </button>
                        </div>
                    </form>

                    <!-- Product Features (unchanged) -->
                    <div class="mt-auto">
                        <h4>Product Features</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item bg-transparent px-0">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>Premium Quality Ingredients
                            </li>
                            <li class="list-group-item bg-transparent px-0">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>Lab Tested for Purity
                            </li>
                            <li class="list-group-item bg-transparent px-0">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>Free Shipping on Orders Over $50
                            </li>
                            <li class="list-group-item bg-transparent px-0">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>30-Day Money Back Guarantee
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Tabs (unchanged structure) -->
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Description</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="nutrition-tab" data-bs-toggle="tab" data-bs-target="#nutrition" type="button" role="tab" aria-controls="nutrition" aria-selected="false">Nutrition Facts</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">Reviews ({{ review_count }})</button>
                </li>
            </ul>
            <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                    <h3>About {{ product.product_name }}</h3>
                    <p>{{ product.description }}</p>
                </div>
                <div class="tab-pane fade" id="nutrition" role="tabpanel" aria-labelledby="nutrition-tab">
                    <h3>Nutrition Facts</h3>
                    <p>Details about the nutritional content of {{ product.product_name }} will be added here.</p>
                </div>
                <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>Customer Reviews</h3>
                        {% if request.user.is_authenticated %}
                            <button class="btn btn-outline-primary" id="writeReviewBtn">
                                <i class="bi bi-pencil me-2"></i>Write a Review
                            </button>
                        {% endif %}
                    </div>

                    <!-- Review Form (unchanged) -->
                    <div id="reviewForm" class="card mb-4 d-none">
                        <div class="card-body">
                            <h4 class="card-title">Write Your Review</h4>
                            <form id="newReviewForm">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="reviewTitle" class="form-label">Title</label>
                                    <input type="text" class="form-control" id="reviewTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rating</label>
                                    <div class="rating-input">
                                        <div class="d-flex">
                                            {% for i in "12345" %}
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input d-none" type="radio" name="rating" id="rating{{ i }}" value="{{ i }}" required>
                                                    <label class="form-check-label rating-star" for="rating{{ i }}">
                                                        <i class="bi bi-star text-warning fs-4"></i>
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reviewComment" class="form-label">Your Review</label>
                                    <textarea class="form-control" id="reviewComment" name="comment" rows="4" required></textarea>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-outline-secondary me-2" id="cancelReviewBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Submit Review</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Reviews List -->
                    {% if reviews %}
                    <div class="reviews-list">
                        {% for review in reviews %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title">{{ review.title|default:"No Title" }}</h5>
                                        <div class="rating-display">
                                            {% for i in "12345" %}
                                            <i class="bi bi-star{% if forloop.counter <= review.rating %}-fill{% endif %} text-warning"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <small class="text-muted">Reviewed by {{ review.user.username }} on {{ review.created_at|date:"F j, Y" }}</small>
                                        {% if review.is_verified_purchase %}
                                            <span class="badge bg-success ms-2">Verified Purchase</span>
                                        {% endif %}
                                    </div>
                                    <p class="card-text">{{ review.comment }}</p>
                                    <div class="d-flex justify-content-end">
                                        <button class="btn btn-sm btn-outline-secondary me-2 helpful-btn" data-review-id="{{ review.id }}">
                                            <i class="bi bi-hand-thumbs-up me-1"></i>Helpful ({{ review.helpful_votes }})
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No reviews yet. Be the first to review this product!
                    </div>
                {% endif %}
            </div>
            </div>
        </div>
    </div>

    <!-- Related Products, Recently Viewed, and Add to Cart Modal (unchanged) -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">You May Also Like</h3>
            <div class="row row-cols-2 row-cols-md-4 g-4">
                {% for related_product in related_products %}
                    <div class="col">
                        <div class="card h-100 product-card">
                            <a href="{% url 'product_app:user_product_detail' related_product.slug %}" class="text-decoration-none">
                                {% with related_product.product_images.first as img %}
                                    {% if img %}
                                        <img src="{{ img.image.url }}" class="card-img-top" alt="{{ related_product.product_name }}">
                                    {% else %}
                                        <img src="{% static 'images/placeholder.jpg' %}" class="card-img-top" alt="Product placeholder">
                                    {% endif %}
                                {% endwith %}
                                <div class="card-body">
                                    <h5 class="card-title text-truncate">{{ related_product.product_name }}</h5>
                                    <p class="card-text text-muted">{{ related_product.brand }}</p>
                                    <p class="card-text fw-bold text-primary">${{ related_product.variants.first.price }}</p>
                                </div>
                            </a>
                            <div class="card-footer bg-transparent border-top-0">
                                <a href="{% url 'cart_and_orders_app:user_add_to_cart' related_product.variants.first.id %}" 
                                   class="btn btn-sm btn-outline-primary w-100 quick-add">
                                    <i class="bi bi-cart-plus me-1"></i>Quick Add
                                </a>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="col-12">
                        <p class="text-muted">No related products found.</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="container-fluid bg-light py-5 mt-5">
        <div class="container">
            <h3 class="mb-4">Recently Viewed</h3>
            <div class="row row-cols-2 row-cols-md-5 g-4" id="recentlyViewedContainer">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="modal fade" id="addToCartModal" tabindex="-1" aria-labelledby="addToCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addToCartModalLabel">
                        <i class="bi bi-check-circle me-2"></i>Added to Cart
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center">
                        <img src="{{ product.product_images.first.image.url }}" alt="{{ product.product_name }}" class="img-thumbnail me-3" style="width: 80px;">
                        <div>
                            <h5 id="modalProductName">{{ product.product_name }}</h5>
                            <p class="mb-0" id="modalVariantInfo">Variant: <span id="modalVariant"></span></p>
                            <p class="mb-0">Quantity: <span id="modalQuantity"></span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Continue Shopping</button>
                    <a href="{% url 'cart_and_orders_app:user_cart_list' %}" class="btn btn-primary">View Cart</a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Thumbnail navigation, variant selection, add to cart, wishlist (unchanged)
        const thumbnails = document.querySelectorAll('.thumbnail-nav');
        thumbnails.forEach(thumb => {
            thumb.addEventListener('click', function() {
                const slideIndex = this.getAttribute('data-bs-slide-to');
                const carousel = new bootstrap.Carousel(document.getElementById('productCarousel'));
                carousel.to(parseInt(slideIndex));
            });
        });

        const variantSelect = document.getElementById('variantSelect');
        const selectedPrice = document.getElementById('selectedPrice');
        const stockStatus = document.getElementById('stockStatus');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const buyNowBtn = document.getElementById('buyNowBtn');
        const quantityInput = document.getElementById('quantity');
        
        function updateVariantDetails() {
            const selectedOption = variantSelect.options[variantSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const stock = parseInt(selectedOption.getAttribute('data-stock'));
            
            selectedPrice.textContent = `$${price}`;
            
            if (stock > 10) {
                stockStatus.textContent = 'In Stock';
                stockStatus.className = 'badge bg-success';
            } else if (stock > 0) {
                stockStatus.textContent = `Only ${stock} left`;
                stockStatus.className = 'badge bg-warning text-dark';
            } else {
                stockStatus.textContent = 'Out of Stock';
                stockStatus.className = 'badge bg-danger';
            }
            
            quantityInput.max = Math.min(stock, 10);
            if (parseInt(quantityInput.value) > quantityInput.max) {
                quantityInput.value = quantityInput.max;
            }
            
            addToCartBtn.disabled = stock <= 0;
            buyNowBtn.disabled = stock <= 0;
            document.getElementById('addToWishlistBtn').disabled = stock <= 0;
            
            document.getElementById('addToCartForm').action = `/cart/add/${variantSelect.value}/`;
        }
        
        updateVariantDetails();
        variantSelect.addEventListener('change', updateVariantDetails);
        
        document.getElementById('decreaseQuantity').addEventListener('click', function() {
            if (quantityInput.value > 1) {
                quantityInput.value = parseInt(quantityInput.value) - 1;
            }
        });
        
        document.getElementById('increaseQuantity').addEventListener('click', function() {
            if (parseInt(quantityInput.value) < parseInt(quantityInput.max)) {
                quantityInput.value = parseInt(quantityInput.value) + 1;
            }
        });
        
        document.getElementById('addToCartBtn').addEventListener('click', function(e) {
            e.preventDefault(); // Still good practice to include, though not strictly necessary with type="button"
            const variantId = variantSelect.value;
            const quantity = quantityInput.value;
            const selectedOption = variantSelect.options[variantSelect.selectedIndex];
            const flavor = selectedOption.getAttribute('data-flavor');
            const size = selectedOption.getAttribute('data-size');
            
            if (!variantId) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please select a variant first.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            document.getElementById('modalVariant').textContent = `${flavor} - ${size}`;
            document.getElementById('modalQuantity').textContent = quantity;
            
            fetch(`/cart/add/${variantId}/`, {  // Use the dynamic action URL
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'  // Switch to JSON for consistency
                },
                body: JSON.stringify({
                    variant_id: variantId,
                    quantity: quantity
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const modal = new bootstrap.Modal(document.getElementById('addToCartModal'));
                    modal.show();
                    const cartBadge = document.querySelector('.navbar .fa-shopping-cart + .badge');
                    if (cartBadge && data.cart_count) {
                        cartBadge.textContent = data.cart_count;
                    }
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Could not add to cart',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while adding to cart.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        });
        

        document.getElementById('buyNowBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = variantSelect.value;
            const quantity = quantityInput.value;
        
            if (!variantId) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please select a variant first.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            fetch('/cart/buy-now/', {  // Ensure this matches your URL pattern
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    variant_id: variantId,
                    quantity: quantity
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    fetch('/set-buy-now-flag/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ from_buy_now: true })
                    })
                    .then(() => {
                        window.location.href = '/checkout/';
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Could not process Buy Now',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while processing your request.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        });

        document.getElementById('addToWishlistBtn').addEventListener('click', function() {
            const variantId = variantSelect.value;
            const quantity = document.getElementById('quantity').value;
            
            if (!variantId) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please select a variant first.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            fetch("{% url 'cart_and_orders_app:user_add_to_wishlist' variant_id=9999 %}".replace('9999', variantId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ quantity: quantity })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                Swal.fire({
                    title: data.success ? 'Added to Wishlist' : 'Info',
                    text: data.message,
                    icon: data.success ? 'success' : 'info',
                    confirmButtonText: 'Continue Shopping',
                    showCancelButton: true,
                    cancelButtonText: 'View Wishlist'
                }).then((result) => {
                    if (!result.isConfirmed) {
                        window.location.href = '/wishlist/';
                    }
                    if (data.success) {
                        const wishlistCountBadge = document.getElementById('wishlist-count');
                        if (wishlistCountBadge) {
                            wishlistCountBadge.textContent = data.wishlist_count;
                        }
                        if (data.wishlist_item) {
                            localStorage.setItem('new_wishlist_item', JSON.stringify(data.wishlist_item));
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while adding to wishlist.', 'error');
            });
        });

        // Review form toggle and submission
        const writeReviewBtn = document.getElementById('writeReviewBtn');
        if (writeReviewBtn) {
            writeReviewBtn.addEventListener('click', function() {
                document.getElementById('reviewForm').classList.remove('d-none');
                this.classList.add('d-none');
            });
        }

        document.getElementById('cancelReviewBtn').addEventListener('click', function() {
            document.getElementById('reviewForm').classList.add('d-none');
            document.getElementById('writeReviewBtn').classList.remove('d-none');
            document.getElementById('newReviewForm').reset();
            const ratingStars = document.querySelectorAll('.rating-star');
            ratingStars.forEach(star => {
                star.querySelector('i').classList.remove('bi-star-fill');
                star.querySelector('i').classList.add('bi-star');
            });
        });

        const ratingStars = document.querySelectorAll('.rating-star');
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const ratingValue = this.previousElementSibling.value;
                ratingStars.forEach(s => {
                    s.querySelector('i').classList.remove('bi-star-fill');
                    s.querySelector('i').classList.add('bi-star');
                });
                for (let i = 0; i < ratingValue; i++) {
                    ratingStars[i].querySelector('i').classList.remove('bi-star');
                    ratingStars[i].querySelector('i').classList.add('bi-star-fill');
                }
            });
        });
        document.getElementById('buyNowBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const variantId = variantSelect.value;
            const quantity = quantityInput.value;
        
            if (!variantId) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please select a variant first.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            fetch('/cart/buy-now/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    variant_id: variantId,
                    quantity: quantity
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Set a session flag via another AJAX call or redirect with parameter
                    fetch('/set-buy-now-flag/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ from_buy_now: true })
                    })
                    .then(() => {
                        window.location.href = '/checkout/';
                    });
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.message || 'Could not process Buy Now',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while processing your request.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        });
        document.getElementById('newReviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('reviewTitle').value;
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const comment = document.getElementById('reviewComment').value;
            const productId = '{{ product.id }}';
        
            if (!rating) {
                Swal.fire({
                    title: 'Error',
                    text: 'Please select a rating.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }
        
            fetch('/add-review/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    product_id: productId,
                    title: title,
                    rating: rating,
                    comment: comment
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Thank You!',
                        text: 'Your review has been submitted successfully.',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // ... (reset form and hide) ...
        
                        // Update average rating and review count
                        const ratingStars = document.querySelector('.rating-stars');
                        const ratingText = document.querySelector('.rating-stars + span');
                        const reviewCountLink = document.querySelector('.rating-stars + span + a');
                        const avgRating = parseFloat(data.average_rating);
                        const reviewCount = data.review_count;
        
                        const starsHtml = Array(5).fill().map((_, i) => {
                            const starNum = i + 1;
                            const floored = Math.floor(avgRating);
                            const decimal = (avgRating % 1).toFixed(1); // Get decimal part directly
                            if (starNum <= 3 && starNum <= floored) {
                                return '<i class="bi bi-star-fill text-warning"></i>';
                            } else if (starNum === 4 && parseFloat(decimal) >= 0.3) {
                                return '<i class="bi bi-star-half text-warning"></i>';
                            } else {
                                return '<i class="bi bi-star text-warning"></i>';
                            }
                        }).join('');
                        ratingStars.innerHTML = starsHtml;
                        ratingText.textContent = `${avgRating.toFixed(1)} / 5`;
                        reviewCountLink.textContent = `(${reviewCount} reviews)`;
                    });
                } else {
                    // ... (error handling) ...
                }
            })
            .catch(error => {
                // ... (error handling) ...
            });
        });

        // Helpful buttons (unchanged)
        const helpfulBtns = document.querySelectorAll('.helpful-btn');
        helpfulBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const reviewId = this.getAttribute('data-review-id');
                fetch(`/api/reviews/${reviewId}/helpful/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const voteCount = data.helpful_votes || 0;
                        btn.innerHTML = `<i class="bi bi-hand-thumbs-up-fill me-1"></i>Helpful (${voteCount})`;
                        btn.classList.add('active');
                        btn.disabled = true;
                    } else {
                        Swal.fire({
                            title: 'Error',
                            text: data.message || 'Could not mark as helpful',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error',
                        text: 'An error occurred while marking as helpful.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            });
        });

        // Recently viewed products (unchanged)
        function addToRecentlyViewed() {
            let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
            const currentProduct = {
                id: '{{ product.id }}',
                name: '{{ product.product_name }}',
                slug: '{{ product.slug }}',
                image: '{{ product.product_images.first.image.url }}',
                price: '{{ product.variants.first.price }}'
            };
            recentlyViewed = recentlyViewed.filter(p => p.id !== currentProduct.id);
            recentlyViewed.unshift(currentProduct);
            recentlyViewed = recentlyViewed.slice(0, 5);
            localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed));
            displayRecentlyViewed(recentlyViewed);
        }

        function displayRecentlyViewed(products) {
            const container = document.getElementById('recentlyViewedContainer');
            if (products.length <= 1) {
                container.closest('.container-fluid').style.display = 'none';
                return;
            }
            container.innerHTML = '';
            products.slice(1).forEach(product => {
                container.innerHTML += `
                    <div class="col">
                        <div class="card h-100 product-card">
                            <a href="/products/${product.slug}/" class="text-decoration-none">
                                <img src="${product.image}" class="card-img-top" alt="${product.name}">
                                <div class="card-body">
                                    <h5 class="card-title text-truncate">${product.name}</h5>
                                    <p class="card-text fw-bold text-primary">$${product.price}</p>
                                </div>
                            </a>
                        </div>
                    </div>
                `;
            });
            container.closest('.container-fluid').style.display = 'block';
        }

        addToRecentlyViewed();

        // Zoom functionality (unchanged)
        const zoomContainers = document.querySelectorAll('.zoom-container');
        zoomContainers.forEach(container => {
            const img = container.querySelector('.zoom-image');
            const lens = container.querySelector('.zoom-lens');
            const result = container.querySelector('.zoom-result');

            if (!img || !lens || !result) {
                console.error('Zoom elements missing in container:', container);
                return;
            }

            container.addEventListener('mouseenter', function() {
                if (img.complete) {
                    lens.classList.add('active');
                    result.classList.add('active');
                    const ratio = img.naturalWidth / img.width;
                    result.style.backgroundImage = `url('${img.src}')`;
                    result.style.backgroundSize = `${img.width * ratio}px ${img.height * ratio}px`;
                    const containerRect = container.getBoundingClientRect();
                    result.style.left = `${containerRect.width + 10}px`;
                    result.style.top = '0px';
                } else {
                    console.warn('Image not loaded yet:', img.src);
                }
            });

            container.addEventListener('mouseleave', function() {
                lens.classList.remove('active');
                result.classList.remove('active');
            });

            container.addEventListener('mousemove', function(e) {
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                let lensX = x - (lens.offsetWidth / 2);
                let lensY = y - (lens.offsetHeight / 2);
                lensX = Math.max(0, Math.min(lensX, img.width - lens.offsetWidth));
                lensY = Math.max(0, Math.min(lensY, img.height - lens.offsetHeight));
                lens.style.left = `${lensX}px`;
                lens.style.top = `${lensY}px`;
                const ratio = img.naturalWidth / img.width;
                const bgX = lensX * ratio;
                const bgY = lensY * ratio;
                result.style.backgroundPosition = `-${bgX}px -${bgY}px`;
            });

            container.addEventListener('click', function() {
                const modal = document.createElement('div');
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.style.zIndex = '9999';
                modal.style.cursor = 'zoom-out';

                const fullImg = document.createElement('img');
                fullImg.src = img.src;
                fullImg.style.maxHeight = '90%';
                fullImg.style.maxWidth = '90%';
                fullImg.style.objectFit = 'contain';

                modal.appendChild(fullImg);
                document.body.appendChild(modal);

                modal.addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
            });
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}