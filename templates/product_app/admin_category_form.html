{% extends 'admin_base.html' %}
{% load static widget_tweaks %}

{% block title %}{{ action }} Category | Admin Panel{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fs-3 fw-bold text-dark mb-1">{{ action }} Category{% if category %}: {{ category.name }}{% endif %}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'user_app:admin_dashboard' %}" class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'product_app:admin_category_list' %}" class="text-decoration-none">Categories</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ action }}</li>
                </ol>
            </nav>
        </div>
        <a href="{% url 'product_app:admin_category_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Back to List
        </a>
    </div>

    <div class="row g-4">
        <!-- Main Form Column -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-normal mb-0">
                        <i class="fas fa-folder me-2 text-primary"></i>Category Information
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="category-form" class="needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Name & Status Section -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <label for="{{ form.name.id_for_label }}" class="form-label">Category Name <span class="text-danger">*</span></label>
                                {% if form.name.errors %}
                                    {% render_field form.name class="form-control is-invalid" %}
                                    <div class="invalid-feedback">
                                        {{ form.name.errors.0 }}
                                    </div>
                                {% else %}
                                    {% render_field form.name class="form-control" %}
                                    <div class="invalid-feedback">
                                        Please enter a valid category name (2-100 characters, letters, numbers, spaces, hyphens, and ampersands only).
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Status</label>
                                <div class="form-check form-switch mt-2">
                                    {% render_field form.is_active class="form-check-input" %}
                                    <label for="{{ form.is_active.id_for_label }}" class="form-check-label ms-1">
                                        <span class="badge bg-{% if form.is_active.value %}success{% else %}warning{% endif %}" id="status-badge">
                                            {% if form.is_active.value %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Offer Percentage -->
                        <div class="mb-4">
                            <label for="{{ form.offer_percentage.id_for_label }}" class="form-label">Offer Percentage (%)</label>
                            {% if form.offer_percentage.errors %}
                                {% render_field form.offer_percentage class="form-control is-invalid" %}
                                <div class="invalid-feedback">
                                    {{ form.offer_percentage.errors.0 }}
                                </div>
                            {% else %}
                                {% render_field form.offer_percentage class="form-control" %}
                                <div class="invalid-feedback">
                                    Please enter a valid percentage between 0 and 100.
                                </div>
                            {% endif %}
                            <div class="form-text">Enter a discount percentage (0-100) or leave blank for no offer (0.00%).</div>
                        </div>

                        <!-- Image Upload -->
                        <div class="mb-4">
                            <label for="{{ form.image.id_for_label }}" class="form-label">Category Image</label>
                            {% if form.image.errors %}
                                {% render_field form.image class="form-control is-invalid" %}
                                <div class="invalid-feedback">
                                    {{ form.image.errors.0 }}
                                </div>
                            {% else %}
                                {% render_field form.image class="form-control" %}
                                <div class="invalid-feedback">
                                    Please upload a valid image file (max 5MB, JPEG/PNG).
                                </div>
                            {% endif %}
                            <div class="form-text">Upload an image (max 5MB, JPEG/PNG).</div>
                            
                            {% if action == "Edit" and category.image %}
                                <div class="form-check mt-2">
                                    <input type="checkbox" name="image-clear" id="image-clear" class="form-check-input">
                                    <label for="image-clear" class="form-check-label">Clear current image</label>
                                </div>
                            {% endif %}
                            <!-- Image Preview -->
                            <div id="image-preview" class="mt-3 {% if not category.image %}d-none{% endif %}">
                                <div class="card border">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center bg-light">
                                        <span class="small fw-semibold"><i class="fas fa-image me-2"></i>Image Preview</span>
                                    </div>
                                    <div class="card-body p-3 text-center">
                                        <img id="preview-img" src="{% if category.image %}{{ category.image.url }}{% endif %}" 
                                             class="img-fluid" style="max-height: 200px;" alt="Category image preview">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {% if form.description.errors %}
                                {% render_field form.description class="form-control is-invalid" %}
                                <div class="invalid-feedback">
                                    {{ form.description.errors.0 }}
                                </div>
                            {% else %}
                                {% render_field form.description class="form-control" %}
                                <div class="invalid-feedback">
                                    Description cannot exceed 500 characters.
                                </div>
                            {% endif %}
                            <div class="form-text">Enter a description (max 500 characters).</div>
                        </div>


                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between pt-2 mt-2 border-top">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-save me-2"></i>{{ action }} Category
                            </button>
                            <a href="{% url 'product_app:admin_category_list' %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Guidelines Column -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-normal mb-0">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>Best Practices
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="fw-bold"><i class="fas fa-check-circle text-success me-2"></i>Naming Tips</h6>
                        <p class="text-muted small mb-2">Use specific, descriptive names:</p>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2">Good</span>
                            <small>"Whey Protein Isolate"</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-danger me-2">Avoid</span>
                            <small>"Protein"</small>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6 class="fw-bold"><i class="fas fa-image text-info me-2"></i>Images</h6>
                        <p class="text-muted small mb-0">Use high-quality images (max 5MB, JPEG/PNG) with clean backgrounds.</p>
                    </div>
                    <div class="mb-4">
                        <h6 class="fw-bold"><i class="fas fa-percent text-primary me-2"></i>Offer Percentage</h6>
                        <p class="text-muted small mb-0">Enter a percentage (0-100) to apply discounts or leave blank for no offer (0.00%).</p>
                    </div>
                    <div>
                        <h6 class="fw-bold"><i class="fas fa-file-alt text-secondary me-2"></i>Descriptions</h6>
                        <p class="text-muted small mb-0">Keep descriptions concise but informative (max 500 characters).</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
$(document).ready(function() {
    // Image preview and validation
    $('#id_image').change(function() {
        const file = this.files[0];
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file) {
            if (file.size > maxSize) {
                Swal.fire({
                    icon: 'error',
                    title: 'File Too Large',
                    text: 'Image file must not exceed 5MB.',
                });
                this.value = '';
                return;
            }
            if (!file.type.startsWith('image/')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File',
                    text: 'Please upload a valid image file (JPEG, PNG, etc.).',
                });
                this.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#preview-img').attr('src', e.target.result);
                $('#image-preview').removeClass('d-none');
            }
            reader.readAsDataURL(file);
        }
    });

    // Clear image checkbox handling
    $('#image-clear').change(function() {
        if ($(this).is(':checked')) {
            $('#id_image').val('');
            $('#preview-img').attr('src', '');
            $('#image-preview').addClass('d-none');
        }
    });

    // Status badge update
    $('#id_is_active').change(function() {
        const badge = $('#status-badge');
        if ($(this).is(':checked')) {
            badge.removeClass('bg-warning').addClass('bg-success').text('Active');
        } else {
            badge.removeClass('bg-success').addClass('bg-warning').text('Inactive');
        }
    });
    $('#id_is_active').trigger('change');

    // Form validation
    $('#category-form').submit(function(e) {
        let valid = true;

        // Name validation
        const name = $('#id_name').val().trim();
        if (!name || name.length < 2 || name.length > 100 || !/^[A-Za-z0-9\s\-\&]+$/.test(name)) {
            $('#id_name').addClass('is-invalid').removeClass('is-valid');
            valid = false;
        } else {
            $('#id_name').removeClass('is-invalid').addClass('is-valid');
        }

        // Description validation
        const description = $('#id_description').val();
        if (description && description.length > 500) {
            $('#id_description').addClass('is-invalid').removeClass('is-valid');
            valid = false;
        } else {
            $('#id_description').removeClass('is-invalid').addClass('is-valid');
        }

        // Offer percentage validation
        const offerPercentage = $('#id_offer_percentage').val().trim();
        if (offerPercentage !== '') {
            const value = parseFloat(offerPercentage);
            if (isNaN(value) || value < 0 || value > 100) {
                $('#id_offer_percentage').addClass('is-invalid').removeClass('is-valid');
                valid = false;
            } else {
                $('#id_offer_percentage').removeClass('is-invalid').addClass('is-valid');
            }
        } else {
            $('#id_offer_percentage').removeClass('is-invalid').addClass('is-valid');
        }

        if (!valid) {
            e.preventDefault();
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 300);
            
            Swal.fire({
                icon: 'error',
                title: 'Validation Error',
                text: 'Please correct the errors in the form.',
            });
        }
    });
});
</script>
{% endblock %}