{% extends 'admin_base.html' %}

{% block title %}
    {% if product %}Edit Product{% else %}Add New Product{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-0">
                {% if product %}Edit Product: {{ product.product_name }}{% else %}Add New Product{% endif %}
            </h2>
            <small class="text-muted">
                {% if product %}Last updated: {{ product.updated_at|date:"F d, Y" }}{% endif %}
            </small>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="productForm" novalidate>
        {% csrf_token %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Basic Information</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="product_name" class="form-label">Product Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="product_name" name="product_name" 
                               value="{{ product_form.product_name.value|default_if_none:'' }}" required
                               pattern="^[A-Za-z0-9\s\-\&\(\)]{2,200}$" maxlength="200">
                        <div class="invalid-feedback">Product name must be 2-200 characters, using letters, numbers, spaces, hyphens, ampersands, or parentheses.</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                        {{ product_form.category }}
                        <div class="invalid-feedback">Please select a category.</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="brand" class="form-label">Brand</label>
                        {{ product_form.brand }}
                        <div class="invalid-feedback">Please select a valid brand.</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    {{ product_form.description }}
                    <div class="invalid-feedback">Description cannot exceed 2000 characters.</div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="country_of_manufacture" class="form-label">Country of Manufacture</label>
                        {{ product_form.country_of_manufacture }}
                        <div class="invalid-feedback">Country of manufacture cannot exceed 100 characters.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Product Variants</h5>
                <div id="variant-container">
                    {% if product %}
                    {% for variant in product.variants.all %}
                        <div class="variant-section mb-4" data-variant-index="{{ forloop.counter0 }}">
                            <a id="variant-{{ variant.id }}"></a> 
                            <input type="hidden" name="variant_id_{{ forloop.counter0 }}" value="{{ variant.id }}">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Flavor</label>
                                    <select class="form-select" name="flavor_{{ forloop.counter0 }}">
                                        <option value="">Select Flavor</option>
                                        {% for flavor_value, flavor_name in flavor_choices %}
                                            <option value="{{ flavor_value }}"
                                                    {% if variant.flavor == flavor_value %}selected{% endif %}>
                                                {{ flavor_name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Size/Weight</label>
                                    <input type="text" class="form-control" name="size_weight_{{ forloop.counter0 }}"
                                           value="{{ variant.size_weight|default_if_none:'' }}" maxlength="50">
                                    <div class="invalid-feedback">Size/Weight cannot exceed 50 characters.</div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Original Price <span class="text-danger">*</span></label>
                                    <input type="number" step="0.01" min="0" class="form-control" name="original_price_{{ forloop.counter0 }}"
                                           value="{{ variant.original_price|floatformat:2 }}" required>
                                    <div class="invalid-feedback">Please enter a valid non-negative price (e.g., 99.99).</div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Offer (%)</label>
                                    <input type="number" step="0.01" min="0" max="100" class="form-control" name="offer_percentage_{{ forloop.counter0 }}"
                                           value="{{ variant.offer_percentage|floatformat:2|default:'0.00' }}">
                                    <div class="invalid-feedback">Offer percentage must be between 0 and 100.</div>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">Stock <span class="text-danger">*</span></label>
                                    <input type="number" min="0" step="1" class="form-control" name="stock_{{ forloop.counter0 }}"
                                           value="{{ variant.stock|default:'0' }}" required>
                                    <div class="invalid-feedback">Please enter a valid non-negative integer for stock.</div>
                                </div>
                                {% if forloop.counter0 > 0 %}
                                    <div class="col-md-1 mb-3">
                                        <button type="button" class="btn btn-danger btn-sm mt-4 remove-variant">Remove</button>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Images (Min 1, Max 3) - Select Primary Image <span class="text-danger">*</span></label>
                                <input type="file" class="form-control image-input" name="images_{{ forloop.counter0 }}"
                                       multiple accept="image/*" data-index="{{ forloop.counter0 }}">
                                <div class="invalid-feedback">At least one image is required and must be a valid image type under 10MB.</div>
                                <div class="image-preview mt-2" data-index="{{ forloop.counter0 }}">
                                    {% if variant.variant_images.all %}
                                        {% for image in variant.variant_images.all %}
                                            <div class="form-check">
                                                <input type="radio" name="primary_image_{{ forloop.parentloop.counter0 }}"
                                                       value="existing_{{ image.id }}"
                                                       class="form-check-input"
                                                       {% if image.is_primary %}checked{% endif %}
                                                       data-image-id="{{ image.id }}">
                                                <label class="form-check-label">
                                                    <img src="{{ image.image.url }}" alt="{{ image.alt_text }}"
                                                         style="max-width: 50px; max-height: 50px;">
                                                    <button type="button" class="btn btn-danger btn-sm remove-image" 
                                                            data-file-index="existing_{{ image.id }}"
                                                            data-image-id="{{ image.id }}">Remove</button>
                                                </label>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <input type="hidden" name="delete_image_ids_{{ forloop.counter0 }}" class="delete-image-ids" data-index="{{ forloop.counter0 }}">
                            </div>
                            <hr>
                        </div>
                    {% endfor %}
                    {% else %}
                    <div class="variant-section mb-4" data-variant-index="0">
                        <a id="variant-0"></a>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Flavor</label>
                                <select class="form-select" name="flavor_0">
                                    <option value="">Select Flavor</option>
                                    {% for flavor_value, flavor_name in flavor_choices %}
                                        <option value="{{ flavor_value }}">{{ flavor_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Size/Weight</label>
                                <input type="text" class="form-control" name="size_weight_0" maxlength="50">
                                <div class="invalid-feedback">Size/Weight cannot exceed 50 characters.</div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Original Price <span class="text-danger">*</span></label>
                                <input type="number" step="0.01" min="0" class="form-control" name="original_price_0" required>
                                <div class="invalid-feedback">Please enter a valid non-negative price (e.g., 99.99).</div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Offer (%)</label>
                                <input type="number" step="0.01" min="0" max="100" class="form-control" name="offer_percentage_0" value="0.00">
                                <div class="invalid-feedback">Offer percentage must be between 0 and 100.</div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Stock <span class="text-danger">*</span></label>
                                <input type="number" min="0" step="1" class="form-control" name="stock_0" required>
                                <div class="invalid-feedback">Please enter a valid non-negative integer for stock.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Images (Min 1, Max 3) - Select Primary Image <span class="text-danger">*</span></label>
                            <input type="file" class="form-control image-input" name="images_0" multiple accept="image/*" data-index="0">
                            <div class="invalid-feedback">At least one image is required and must be a valid image type under 10MB.</div>
                            <div class="image-preview mt-2" data-index="0"></div>
                            <input type="hidden" name="delete_image_ids_0" class="delete-image-ids" data-index="0">
                        </div>
                        <hr>
                    </div>
                    {% endif %}
                </div>
                <input type="hidden" id="variant_count" name="variant_count" value="{% if product %}{{ product.variants.count }}{% else %}1{% endif %}">
                <button type="button" class="btn btn-primary" id="addVariant">Add Variant</button>
            </div>
        </div>

        <div class="mb-4">
            <button type="submit" class="btn btn-primary">{% if product %}Update Product{% else %}Add Product{% endif %}</button>
            <a href="{% url 'product_app:admin_product_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="img-container">
                    <img id="imageToCrop" src="" alt="Image to crop">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="cropImage">Crop</button>
            </div>
        </div>
    </div>
</div>

<!-- Include Cropper.js, Bootstrap, and SweetAlert2 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .image-preview img {
        max-width: 100px;
        max-height: 100px;
        margin: 5px;
        object-fit: cover;
    }
    .img-container {
        max-height: 400px;
        overflow: hidden;
    }
    #imageToCrop {
        display: block;
        max-width: 100%;
    }
    .existing-images .form-check, .image-preview .form-check {
        margin-bottom: 10px;
    }
    .is-invalid {
        border-color: #dc3545;
    }
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875em;
    }
    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const variantContainer = document.getElementById('variant-container');
        const addVariantBtn = document.getElementById('addVariant');
        const variantCountInput = document.getElementById('variant_count');
        const productForm = document.getElementById('productForm');
        if (!productForm) {
            console.error('Product form not found');
            return;
        }
        let variantIndex = parseInt(variantCountInput.value) || 0;
        let cropper;
        let currentInput;
        let currentPreview;
        let currentFileIndex;

        function validateField(input) {
            const fieldName = input.name;
            input.classList.remove('is-invalid');
            const feedback = input.nextElementSibling?.classList.contains('invalid-feedback') ? input.nextElementSibling : null;
        
            if (input.required && !input.value.trim()) {
                input.classList.add('is-invalid');
                return false;
            }
        
            if (fieldName.includes('product_name')) {
                const value = input.value.trim();
                if (value.length < 2 || value.length > 200) {
                    input.classList.add('is-invalid');
                    return false;
                }
                if (!/^[A-Za-z0-9\s\-\&\(\)]+$/.test(value)) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('description')) {
                if (input.value.length > 2000) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('country_of_manufacture')) {
                if (input.value.length > 100) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('size_weight')) {
                if (input.value.length > 50) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('original_price')) {
                const value = parseFloat(input.value);
                if (isNaN(value) || value < 0) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('offer_percentage')) {
                const value = parseFloat(input.value);
                if (!input.value.trim()) return true; // Optional
                if (isNaN(value) || value < 0 || value > 100) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('stock')) {
                const value = parseInt(input.value);
                if (isNaN(value) || value < 0) {
                    input.classList.add('is-invalid');
                    return false;
                }
            } else if (fieldName.includes('category') && input.required && !input.value) {
                input.classList.add('is-invalid');
                return false;
            } else if (fieldName.includes('images_')) {
                const index = input.dataset.index;
                const files = input.files || [];
                const preview = document.querySelector(`.image-preview[data-index="${index}"]`);
                const existingImageRadios = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="existing_"]`);
                const deleteIdsInput = document.querySelector(`input[name="delete_image_ids_${index}"]`);
                const deleteIds = deleteIdsInput.value.split(',').filter(id => id);
                const remainingExistingImages = Array.from(existingImageRadios).filter(radio => !deleteIds.includes(radio.value.split('_')[1])).length;
                const totalImages = remainingExistingImages + files.length;
        
                console.log(`Variant ${index}: remainingExistingImages=${remainingExistingImages}, newImages=${files.length}, deleteIds=${deleteIds}, totalImages=${totalImages}`);
        
                if (totalImages < 1) {
                    input.classList.add('is-invalid');
                    feedback.textContent = 'At least one image is required.';
                    return false;
                }
                if (totalImages > 3) {
                    input.classList.add('is-invalid');
                    feedback.textContent = 'Maximum of 3 images allowed.';
                    return false;
                }
                const primaryRadio = document.querySelector(`input[name="primary_image_${index}"]:checked`);
                if (totalImages > 1 && !primaryRadio) {
                    input.classList.add('is-invalid');
                    feedback.textContent = 'Please select a primary image.';
                    return false;
                }
                for (let file of files) {
                    if (file.size > 10 * 1024 * 1024) {
                        input.classList.add('is-invalid');
                        feedback.textContent = 'Each image must be under 10MB.';
                        return false;
                    }
                    if (!file.type.startsWith('image/')) {
                        input.classList.add('is-invalid');
                        feedback.textContent = 'All files must be valid images.';
                        return false;
                    }
                }
                input.classList.remove('is-invalid');
                return true;
            }
        
            return true;
        }

        // Add validation listeners to existing inputs
        productForm.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('blur', () => validateField(input));
            input.addEventListener('input', () => validateField(input));
            if (input.type === 'file') {
                input.addEventListener('change', function() {
                    handleImagePreview(this);
                    validateField(this);
                });
            }
        });

        // Handle image preview and primary image selection
        function handleImagePreview(input) {
            const index = input.dataset.index;
            const files = input.files;
            const preview = document.querySelector(`.image-preview[data-index="${index}"]`);
            const existingRadios = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="existing_"]`).length;

            // Clear new image previews but keep existing images
            preview.querySelectorAll('.new-image').forEach(el => el.remove());

            const validFiles = Array.from(files).filter(file => {
                if (file.size > 10 * 1024 * 1024) {
                    input.classList.add('is-invalid');
                    input.nextElementSibling.textContent = 'Each image must be under 10MB.';
                    return false;
                }
                if (!file.type.startsWith('image/')) {
                    input.classList.add('is-invalid');
                    input.nextElementSibling.textContent = 'All files must be valid images.';
                    return false;
                }
                return true;
            });

            validFiles.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'form-check new-image';
                    div.innerHTML = `
                        <input type="radio" name="primary_image_${index}" 
                               value="new_${i}" class="form-check-input" 
                               data-file-index="new_${i}" 
                               ${existingRadios === 0 && i === 0 ? 'checked' : ''}>
                        <label class="form-check-label">
                            <img src="${e.target.result}" alt="Preview" class="preview-image" 
                                 data-file-index="new_${i}" style="max-width: 50px; max-height: 50px; cursor: pointer;">
                            <button type="button" class="btn btn-danger btn-sm remove-image" 
                                    data-file-index="new_${i}">Remove</button>
                        </label>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });

            // Update file input with valid files
            const dataTransfer = new DataTransfer();
            validFiles.forEach(file => dataTransfer.items.add(file));
            input.files = dataTransfer.files;

            // Re-validate after updating preview
            validateField(input);
        }

        // Remove variant - NEW EVENT LISTENER
        variantContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-variant')) {
                e.preventDefault();
                e.stopPropagation();
                
                const variantSection = e.target.closest('.variant-section');
                
                // Don't allow removing if there's only one variant
                const totalVariants = variantContainer.querySelectorAll('.variant-section').length;
                if (totalVariants <= 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cannot Remove',
                        text: 'At least one variant is required.',
                    });
                    return;
                }
                
                Swal.fire({
                    icon: 'warning',
                    title: 'Confirm Deletion',
                    text: 'Are you sure you want to remove this variant?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        variantSection.remove();
                        
                        // Update variant count
                        const remainingVariants = variantContainer.querySelectorAll('.variant-section').length;
                        variantCountInput.value = remainingVariants;
                    }
                });
            }
        });

        // Remove image from variant
        variantContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-image')) {
                e.preventDefault();
                e.stopPropagation();
        
                const formCheck = e.target.closest('.form-check');
                const preview = formCheck.closest('.image-preview');
                const index = preview.dataset.index;
                const fileIndex = e.target.dataset.fileIndex;
                const imageInput = document.querySelector(`input[name="images_${index}"]`);
                const deleteImageIdsInput = document.querySelector(`input[name="delete_image_ids_${index}"]`);
        
                Swal.fire({
                    icon: 'warning',
                    title: 'Confirm Deletion',
                    text: 'Are you sure you want to remove this image?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (fileIndex.startsWith('existing_')) {
                            const imageId = fileIndex.split('_')[1];
                            let deleteIds = deleteImageIdsInput.value.split(',').filter(id => id);
                            if (!deleteIds.includes(imageId)) {
                                deleteIds.push(imageId);
                            }
                            deleteImageIdsInput.value = deleteIds.join(',');
                            console.log(`Variant ${index}: Added image ID ${imageId} to delete_image_ids, new value: ${deleteImageIdsInput.value}`);
                        } else {
                            const newIndex = parseInt(fileIndex.split('_')[1]);
                            const files = Array.from(imageInput.files);
                            const newFiles = files.filter((_, i) => i !== newIndex);
                            const dataTransfer = new DataTransfer();
                            newFiles.forEach(file => dataTransfer.items.add(file));
                            imageInput.files = dataTransfer.files;
                            console.log(`Variant ${index}: Removed new image at index ${newIndex}, remaining new images: ${newFiles.length}`);
                        }
        
                        formCheck.remove();
        
                        // Update radio button values for new images
                        const remainingNewRadios = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="new_"]`);
                        remainingNewRadios.forEach((radio, i) => {
                            const img = radio.closest('.form-check').querySelector('img');
                            const removeBtn = radio.closest('.form-check').querySelector('.remove-image');
                            radio.value = `new_${i}`;
                            if (img) img.dataset.fileIndex = `new_${i}`;
                            if (removeBtn) removeBtn.dataset.fileIndex = `new_${i}`;
                        });
        
                        // Ensure primary image is selected
                        const existingImageRadios = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="existing_"]`);
                        const deleteIds = deleteImageIdsInput.value.split(',').filter(id => id);
                        const remainingExistingImages = Array.from(existingImageRadios).filter(radio => !deleteIds.includes(radio.value.split('_')[1])).length;
                        const newImages = imageInput.files.length;
                        const totalImages = remainingExistingImages + newImages;
        
                        console.log(`Variant ${index} after removal: remainingExistingImages=${remainingExistingImages}, newImages=${newImages}, totalImages=${totalImages}`);
        
                        if (totalImages > 0) {
                            const checkedRadio = preview.querySelector(`input[name="primary_image_${index}"]:checked`);
                            if (!checkedRadio) {
                                const firstRadio = preview.querySelector(`input[name="primary_image_${index}"]`);
                                if (firstRadio) {
                                    firstRadio.checked = true;
                                    console.log(`Variant ${index}: Automatically selected primary image: ${firstRadio.value}`);
                                }
                            }
                        }
        
                        // Re-validate images
                        validateField(imageInput);
                    }
                });
            }
        });

        // Add new variant
        addVariantBtn.addEventListener('click', function() {
            const newVariant = document.createElement('div');
            newVariant.className = 'variant-section mb-4';
            newVariant.dataset.variantIndex = variantIndex;
            newVariant.innerHTML = `
                <a id="variant-${variantIndex}"></a>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Flavor</label>
                        <select class="form-select" name="flavor_${variantIndex}">
                            <option value="">Select Flavor</option>
                            {% for flavor_value, flavor_name in flavor_choices %}
                                <option value="{{ flavor_value }}">{{ flavor_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Size/Weight</label>
                        <input type="text" class="form-control" name="size_weight_${variantIndex}" maxlength="50">
                        <div class="invalid-feedback">Size/Weight cannot exceed 50 characters.</div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Original Price <span class="text-danger">*</span></label>
                        <input type="number" step="0.01" min="0" class="form-control" name="original_price_${variantIndex}" required>
                        <div class="invalid-feedback">Please enter a valid non-negative price (e.g., 99.99).</div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Offer (%)</label>
                        <input type="number" step="0.01" min="0" max="100" class="form-control" name="offer_percentage_${variantIndex}" value="0.00">
                        <div class="invalid-feedback">Offer percentage must be between 0 and 100.</div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Stock <span class="text-danger">*</span></label>
                        <input type="number" min="0" step="1" class="form-control" name="stock_${variantIndex}" required>
                        <div class="invalid-feedback">Please enter a valid non-negative integer for stock.</div>
                    </div>
                    <div class="col-md-1 mb-3">
                        <button type="button" class="btn btn-danger btn-sm mt-4 remove-variant">Remove</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Images (Min 1, Max 3) - Select Primary Image <span class="text-danger">*</span></label>
                    <input type="file" class="form-control image-input" name="images_${variantIndex}" multiple accept="image/*" data-index="${variantIndex}">
                    <div class="invalid-feedback">At least one image is required and must be a valid image type under 10MB.</div>
                    <div class="image-preview mt-2" data-index="${variantIndex}"></div>
                    <input type="hidden" name="delete_image_ids_${variantIndex}" class="delete-image-ids" data-index="${variantIndex}">
                </div>
                <hr>
            `;
            variantContainer.appendChild(newVariant);

            // Add validation listeners to new inputs
            newVariant.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('blur', () => validateField(input));
                input.addEventListener('input', () => validateField(input));
                if (input.type === 'file') {
                    input.addEventListener('change', function() {
                        handleImagePreview(this);
                        validateField(this);
                    });
                }
            });

            variantIndex++;
            variantCountInput.value = variantIndex;
        });

        // Image click for cropping
        variantContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('preview-image')) {
                e.preventDefault();
                e.stopPropagation();

                const index = e.target.closest('.image-preview').dataset.index;
                const fileIndex = e.target.dataset.fileIndex;
                currentPreview = e.target.closest('.image-preview');
                currentInput = document.querySelector(`input[name="images_${index}"]`);
                currentFileIndex = fileIndex;

                if (fileIndex && fileIndex.startsWith('new_')) {
                    const newIndex = parseInt(fileIndex.split('_')[1]);
                    const file = currentInput.files[newIndex];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const modal = new bootstrap.Modal(document.getElementById('cropperModal'));
                        const imageToCrop = document.getElementById('imageToCrop');
                        imageToCrop.src = event.target.result;

                        modal.show();
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(imageToCrop, {
                            aspectRatio: 1,
                            viewMode: 1,
                            autoCropArea: 0.8,
                        });
                    };
                    reader.readAsDataURL(file);
                } else if (fileIndex && fileIndex.startsWith('existing_')) {
                    const imgSrc = e.target.src;
                    const modal = new bootstrap.Modal(document.getElementById('cropperModal'));
                    const imageToCrop = document.getElementById('imageToCrop');
                    imageToCrop.src = imgSrc;

                    modal.show();
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8,
                        dragMode: 'move',
                        cropBoxMovable: false,
                        cropBoxResizable: false,
                        zoomable: true
                    });

                    document.getElementById('cropImage').disabled = true;
                    document.getElementById('cropperModalLabel').textContent = 'View Image (Existing images cannot be cropped)';
                }
            }
        });

        // Remove image
        variantContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-image')) {
                e.preventDefault();
                e.stopPropagation();

                const formCheck = e.target.closest('.form-check');
                const preview = formCheck.closest('.image-preview');
                const index = preview.dataset.index;
                const fileIndex = e.target.dataset.fileIndex;
                const imageInput = document.querySelector(`input[name="images_${index}"]`);
                const deleteImageIdsInput = document.querySelector(`input[name="delete_image_ids_${index}"]`);

                Swal.fire({
                    icon: 'warning',
                    title: 'Confirm Deletion',
                    text: 'Are you sure you want to remove this image?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, remove it',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (fileIndex.startsWith('existing_')) {
                            const imageId = fileIndex.split('_')[1];
                            let deleteIds = deleteImageIdsInput.value.split(',').filter(id => id);
                            deleteIds.push(imageId);
                            deleteImageIdsInput.value = deleteIds.join(',');
                        } else {
                            const newIndex = parseInt(fileIndex.split('_')[1]);
                            const files = Array.from(imageInput.files);
                            const newFiles = files.filter((_, i) => i !== newIndex);
                            const dataTransfer = new DataTransfer();
                            newFiles.forEach(file => dataTransfer.items.add(file));
                            imageInput.files = dataTransfer.files;
                        }

                        formCheck.remove();

                        // Update radio button values for new images
                        const remainingRadios = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="new_"]`);
                        remainingRadios.forEach((radio, i) => {
                            const img = radio.closest('.form-check').querySelector('img');
                            const removeBtn = radio.closest('.form-check').querySelector('.remove-image');
                            radio.value = `new_${i}`;
                            if (img) img.dataset.fileIndex = `new_${i}`;
                            if (removeBtn) removeBtn.dataset.fileIndex = `new_${i}`;
                        });

                        // Ensure primary image is selected
                        const existingImages = preview.querySelectorAll(`input[name="primary_image_${index}"][value^="existing_"]`).length;
                        const newImages = imageInput.files.length;
                        const deleteIds = deleteImageIdsInput.value.split(',').filter(id => id);
                        const totalImages = existingImages + newImages - deleteIds.length;

                        if (totalImages === 1) {
                            const firstRadio = preview.querySelector(`input[name="primary_image_${index}"]`);
                            if (firstRadio) firstRadio.checked = true;
                        } else if (!preview.querySelector(`input[name="primary_image_${index}"]:checked`)) {
                            const firstRadio = preview.querySelector(`input[name="primary_image_${index}"]`);
                            if (firstRadio) firstRadio.checked = true;
                        }

                        // Re-validate images
                        validateField(imageInput);
                    }
                });
            }
        });

        // Crop image
        document.getElementById('cropImage').addEventListener('click', function() {
            if (!cropper || this.disabled) return;

            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 300,
            });

            canvas.toBlob(function(blob) {
                const file = new File([blob], `cropped_image_${Date.now()}.jpg`, { type: 'image/jpeg' });

                if (currentFileIndex && currentFileIndex.startsWith('new_')) {
                    const files = Array.from(currentInput.files);
                    const fileIndex = parseInt(currentFileIndex.split('_')[1]);

                    files[fileIndex] = file;

                    const dataTransfer = new DataTransfer();
                    files.forEach(f => dataTransfer.items.add(f));
                    currentInput.files = dataTransfer.files;

                    const img = currentPreview.querySelector(`img[data-file-index="new_${fileIndex}"]`);
                    if (img) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                }

                cropper.destroy();
                cropper = null;
                bootstrap.Modal.getInstance(document.getElementById('cropperModal')).hide();

                document.getElementById('cropImage').disabled = false;
                document.getElementById('cropperModalLabel').textContent = 'Crop Image';
            }, 'image/jpeg');
        });

        // Reset modal when hidden
        document.getElementById('cropperModal').addEventListener('hidden.bs.modal', function() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('cropImage').disabled = false;
            document.getElementById('cropperModalLabel').textContent = 'Crop Image';
        });

        // Form submission
        productForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const variantCount = variantContainer.querySelectorAll('.variant-section').length;
            if (variantCount === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please add at least one variant.',
                });
                return;
            }

            // Validate all fields
            let isValid = true;
            productForm.querySelectorAll('input, select, textarea').forEach(input => {
                if (!validateField(input)) isValid = false;
            });

            if (!isValid) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    text: 'Please correct the errors in the form before submitting.',
                });
                return;
            }

            const formData = new FormData(this);
            const url = "{% if product %}{% url 'product_app:admin_edit_product' product.slug %}{% else %}{% url 'product_app:admin_add_product' %}{% endif %}";

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: data.message,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = "{% url 'product_app:admin_product_list' %}";
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'An error occurred. Please try again.',
                    });

                    // Display field-specific errors
                    if (data.errors) {
                        Object.keys(data.errors).forEach(field => {
                            const input = document.querySelector(`[name="${field}"]`);
                            if (input) {
                                input.classList.add('is-invalid');
                                const feedback = input.nextElementSibling?.classList.contains('invalid-feedback') 
                                    ? input.nextElementSibling 
                                    : null;
                                if (feedback) {
                                    feedback.textContent = data.errors[field][0].message;
                                }
                            }
                        });
                    }

                    // Handle variant-specific errors
                    if (data.message.includes('variant')) {
                        const match = data.message.match(/variant (\d+)/);
                        if (match) {
                            const variantIdx = parseInt(match[1]) - 1;
                            const variantSection = document.querySelector(`.variant-section[data-variant-index="${variantIdx}"]`);
                            if (variantSection) {
                                const imageInput = variantSection.querySelector('.image-input');
                                imageInput.classList.add('is-invalid');
                                imageInput.nextElementSibling.textContent = data.message;
                            }
                        }
                    }
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An unexpected error occurred: ' + error.message,
                });
                console.error('Error:', error);
            });
        });
    });
</script>
{% endblock %}